@model IEnumerable<QueueSystem.Models.ManHinh>
@{
    ViewBag.Title = "Home";
    //Layout = "/Views/Shared/_LayoutView.cshtml";
}

<div class="row" >
    @foreach (var item in Model)
    {
        <div class="col-md-2" style="text-align:center">
            <i class="fa fa-television fa-5x" aria-hidden="true"></i>
            <p><a class="btn" title="Hiển thị màn hình" href="#" onclick="window.open('/HeThongSos/ViewDetails/' + @item.ID)">Hiển thị trang mới</a></p>
            <p>@item.ManHinhSo</p>
            <p>
                @*@Html.ActionLink(item.ManHinhSo, "Details", new { id =item.ID})
                @Html.ActionLink("Details", "Details", "HeThongSoes", new { id = item.ID })*@
                <a class="btn" title="Hiển thị cổng"
                   href="#" onclick="MyFunction(@item.ID);return false;">Hiển thị cổng</a>
            </p>
        </div>
    }
</div>
@*<audio autoplay id="bgsound" preload="auto" controls="">
    <source src="/lib/Voice_mp3/c7.mp3" type="audio/mp3">
</audio>*@

<div id="conten">
    <div id="showManHinh"></div>
    <div id="showNext"></div>

    @*<audio id="audio" controls="" type="audio/mp3">
        <source type="audio/mp3" src="/lib/Voice_mp3/m1.mp3">
        Trình duyệt của bạn không hỗ trợ html5 để phát âm thanh
    </audio>
    <ul id="playlist" >
    </ul>*@
    <audio style="display:none;" id="container" controls="" autoplay=""></audio>
</div>
<script>
    (function () {
        var Mp3Queue = function (container, files) {
            var index = 1;
            if (!container || !container.tagName || container.tagName !== 'AUDIO') throw 'Invalid container';
            if (!files || !files.length) throw 'Invalid files array';

            var playNext = function () {
                if (index < files.length) {
                    container.src = files[index];
                    index += 1;
                } else {
                    container.removeEventListener('ended', playNext, false);
                }
            };

            container.addEventListener('ended', playNext);

            container.src = files[0];
        };

        var container = document.getElementById('container');

        //var audio;
        //var playlist;
        //var tracks;
        //var current = 0;
        //var lastplay = 0;

        //function onloadInit() {
        //    current = 0;
        //    audio = $('audio');
        //    playlist = $('#playlist');
        //    tracks = playlist.find('li a');
        //    len = tracks.length - 1;
        //    audio[0].volume = 1;
        //    playlist.find('a').click(function (e) {
        //        e.preventDefault();
        //        link = $(this);
        //        current = link.parent().index();
        //        run(link, audio[0], lastplay, current);
        //    });
        //    audio[0].addEventListener('ended', function (e) {
        //        current++;
        //        if (current > len) {
        //            current = 0;
        //            link = playlist.find('a')[0];
        //            lastplay = 1;
        //        } else {
        //            link = playlist.find('a')[current];
        //            lastplay = 0;
        //        }
        //        run($(link), audio[0], lastplay, current);
        //    });
        //}
        //function run(link, player, lastplay, current) {
        //    player.src = link.attr('href');
        //    par = link.parent();
        //    var id = $("#audi_" + current);
        //    //id.addClass('active').siblings().removeClass('active');
        //    par.addClass('active').siblings().removeClass('active');
        //    audio[0].load();
        //    if (lastplay != 1)
        //    {
        //        audio[0].play();
        //    }
        
        //}

        MyFunction = function(id){
            $('#showManHinh').empty();
            $('#showNext').empty();
            $('#playlist').empty();
            $.ajax({
                type: 'GET',
                url: '/HeThongSos/Show/' + id,
                data: "",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (msg) {
                    if(msg.ID != 99999){
                        $('#showManHinh').append(
                             msg.STT
                        );
                        $('#showNext').append(
                             '<button class="btn" onclick="Next('+id+');return false;">Gọi tiếp</button>'
                             +'<button class="btn" onclick="MyFunction('+id+');return false;">Gọi Lại</button>'
                        );
                        StrSplit(msg.STT);
                    }else{
                        $('#showManHinh').append(
                             "Đã hết lượt khám"
                        );
                    }
                }
            });
        }
        Next = function(id){
            $('#showManHinh').empty();
            $('#showNext').empty();
            $('#playlist').empty();
            $.ajax({
                type: 'GET',
                url: '/HeThongSos/ShowSo/' + id,
                data: "",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: function (msg) {
                    if(msg.STT != 0){
                        $('#showManHinh').append(
                             msg.STT
                        );
                        $('#showNext').append(
                             '<button class="btn" onclick="Next('+id+');return false;">Gọi tiếp</button>'
                             +'<button class="btn" onclick="MyFunction('+id+');return false;">Gọi Lại</button>'
                        );
                        StrSplit(msg.STT);
                        //onloadInit();
                    }else{
                        $('#showManHinh').append(
                             "Đã hết lượt khám"
                        );
                    }
                }
            });
        };
        function StrSplit(str) {
            $('#playlist').empty();
            var output = [];
            var sNumber = str.toString();
            for (var i = 0, len = sNumber.length; i < len; i += 1) {
                output.push(sNumber[i]);
            }
            var str = ['/lib/Voice_mp3/m1.mp3','/lib/Voice_mp3/m3.mp3'];
            var j = 0;
            output.forEach(function (value) {
                if ( (3 > output.length && output.length > 1 && value == 1 && j == 0) || (4 > output.length && output.length > 2 && value == 1 && j == 1)) {
                    str.push('/lib/Voice_mp3/sb.mp3');
                    j++;
                }
                else
                {
                    switch (value) {
                        case "0":
                            if ( output.length == 2 && j == 0) {
                                str.push('/lib/Voice_mp3/sc.mp3');
                                j++;
                            }
                            //else
                            //{
                            //    str.push('/lib/Voice_mp3/s0.mp3');
                            //}
                            break;
                        case "1":
                            str.push('/lib/Voice_mp3/s1.mp3');
                            break;
                        case "2":
                            str.push('/lib/Voice_mp3/s2.mp3');
                            break;
                        case "3":
                            str.push('/lib/Voice_mp3/s3.mp3');
                            break;
                        case "4":
                            str.push('/lib/Voice_mp3/s4.mp3');
                            break;
                        case "5":
                            str.push('/lib/Voice_mp3/s5.mp3');
                            break;
                        case "6":
                            str.push('/lib/Voice_mp3/s6.mp3');
                            break;
                        case "7":
                            str.push('/lib/Voice_mp3/s7.mp3');
                            break;
                        case "8":
                            str.push('/lib/Voice_mp3/s8.mp3');
                            break;
                        case "9":
                            str.push('/lib/Voice_mp3/s9.mp3');
                            break;
                    }
                }
            });

            //$('#playlist').append(str);
            //onloadInit();
            
            new Mp3Queue(container, str);
        }


    })();
</script>
<style type="text/css">
    /*div #conten{
        background-image: url('../../Images/tv_PNG479.png');
        top: 50%;
        left: 50%;
        padding: 20px;
        resize: both;
        overflow: auto;
        background-repeat:no-repeat;
        background-size:contain;
        background-position:center;
        min-height: 400px;
        min-width: 400px;
        overflow: auto;
        padding: 20px;
        resize: both;
        top: 50%;
    }*/
    div #conten #showManHinh {
      width: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      resize: both;
      font-size: 80px;
    }
    div #conten #showNext {
      width: 50%;
      position: absolute;
      top: 70%;
      left: 40%;
      resize: both;
    }
    /*#playlist,audio{background:#666;width:400px;padding:20px;}
    .active a{color:#5DB0E6;text-decoration:none;}
    li a{color:#eeeedd;background:#333;padding:5px;display:block;}
    li a:hover{text-decoration:none;}*/
    div #conten #showManHinh {
        text-align: center;
        font-size:300px;
        font-weight: bold;
        position: absolute;
        width: 100px;
        height: 50px;
        top: 50%;
        left: 50%;
        margin-left: -50px; /* margin is -0.5 * dimension */
        margin-top: -150px; 
    }
    div #conten #showNext {
        text-align: center;
        font-size:50px;
        font-weight: bold;
        position: absolute;
        width: 100px;
        height: 50px;
        top: 70%;
        left: 40%;
        margin-left: -50px; /* margin is -0.5 * dimension */
        margin-top: -150px; 
    }
</style>